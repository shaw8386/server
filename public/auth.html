<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GI8 ‚Äî X√°c th·ª±c Telegram</title>
  <style>
    body{font-family:system-ui;background:#f5f7fb;margin:0;padding:16px}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);max-width:420px;margin:18px auto}
    .title{font-weight:900;font-size:18px;margin-bottom:10px}
    .msg{display:none;background:#fff3cd;border:1px solid #ffe69c;color:#6b4e00;padding:10px;border-radius:10px;font-weight:700;margin-bottom:10px}
    .panel{margin-top:12px;padding:10px;border:1px dashed #cfd6e4;border-radius:12px;background:#fafcff}
    .hint{color:#666;font-weight:700;font-size:13px;margin-top:8px}
  </style>
</head>
<body>
  <div class="card">
    <div class="title">üß© GI8 ‚Äî X√°c th·ª±c Telegram</div>
    <div id="msg" class="msg"></div>

    <div class="panel">
      <div style="font-weight:900;margin-bottom:8px;">üîΩ B·∫•m ƒë·ªÉ x√°c th·ª±c</div>
      <div id="tgWrap"></div>
      <div class="hint">Sau khi x√°c th·ª±c xong, h·ªá th·ªëng s·∫Ω t·ª± quay l·∫°i app.</div>
    </div>
  </div>

<script>
  const TG_BOT_USERNAME = "gi8_check_bot";
  const API_BASE = ""; // c√πng domain railway th√¨ ƒë·ªÉ r·ªóng

  const $ = (id)=>document.getElementById(id);
  function showMsg(t){ const el=$("msg"); el.style.display="block"; el.textContent=t; }
  function hideMsg(){ const el=$("msg"); el.style.display="none"; el.textContent=""; }

  function mountWidget(){
    const wrap = $("tgWrap");
    wrap.innerHTML = "";

    window.onTelegramAuth = async (tgUser)=>{
      hideMsg();
      try{
        // ‚úÖ NEW: g·ªçi endpoint identify (d√πng cho c·∫£ login & register)
        const r = await fetch(API_BASE + "/auth/telegram-identify",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(tgUser)
        });

        const data = await r.json();

        if(!data.success){
          showMsg(data.message || "X√°c th·ª±c th·∫•t b·∫°i");
          return;
        }

        // ‚úÖ n·∫øu ƒë√£ t·ªìn t·∫°i -> tr·∫£ login_token
        if(data.status === "EXISTS"){
          location.href =
            "gi8://tgreg?status=EXISTS"
            + "&login_token=" + encodeURIComponent(data.login_token || "")
            + "&full_name=" + encodeURIComponent(data.full_name || "");
          return;
        }

        // ‚úÖ user m·ªõi -> tr·∫£ reg_token
        if(data.status === "CREATED"){
          location.href =
            "gi8://tgreg?status=CREATED"
            + "&reg_token=" + encodeURIComponent(data.reg_token || "")
            + "&full_name=" + encodeURIComponent(data.full_name || "");
          return;
        }

        showMsg("‚ö†Ô∏è Tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá: " + (data.status || "unknown"));
      }catch(e){
        showMsg("‚ùå L·ªói k·∫øt n·ªëi server");
      }
    };

    const s = document.createElement("script");
    s.async = true;
    s.src = "https://telegram.org/js/telegram-widget.js?22";
    s.setAttribute("data-telegram-login", TG_BOT_USERNAME);
    s.setAttribute("data-size", "large");
    s.setAttribute("data-userpic", "false");
    s.setAttribute("data-request-access", "write");
    s.setAttribute("data-onauth", "onTelegramAuth(user)");
    wrap.appendChild(s);
  }

  mountWidget();
</script>
</body>
</html>
