<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GI8 ‚Äî ƒêƒÉng k√Ω Telegram</title>
  <style>
    body{font-family:system-ui;background:#f5f7fb;margin:0;padding:16px}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);max-width:420px;margin:18px auto}
    .title{font-weight:900;font-size:18px;margin-bottom:10px}
    .msg{display:none;background:#fff3cd;border:1px solid #ffe69c;color:#6b4e00;padding:10px;border-radius:10px;font-weight:700;margin-bottom:10px}
    .panel{margin-top:12px;padding:10px;border:1px dashed #cfd6e4;border-radius:12px;background:#fafcff}
  </style>
</head>
<body>
  <div class="card">
    <div class="title">üß© X·ªï S·ªë Gi8 ‚Äî ƒêƒÉng K√Ω T√†i Kho·∫£n</div>
    <div id="msg" class="msg"></div>

    <div class="panel">
      <div style="font-weight:900;margin-bottom:8px;">üîΩ X√°c th·ª±c Telegram</div>
      <div id="tgWrap"></div>
    </div>
  </div>

<script>
  const TG_BOT_USERNAME = "gi8_check_bot";
  const API_BASE = ""; // c√πng domain railway

  const $ = (id)=>document.getElementById(id);
  function showMsg(t){ const el=$("msg"); el.style.display="block"; el.textContent=t; }
  function hideMsg(){ const el=$("msg"); el.style.display="none"; el.textContent=""; }

  function mountWidget(){
    const wrap = $("tgWrap");
    wrap.innerHTML = "";

    window.onTelegramAuth = async (tgUser)=>{
      hideMsg();
      try{
        const r = await fetch(API_BASE + "/auth/telegram-register",{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(tgUser)
        });
        const data = await r.json();

        if(!data.success){
          // user ƒë√£ t·ªìn t·∫°i -> quay v·ªÅ app ƒë·ªÉ user login b·∫±ng pass
          if(data.code==="EXISTS"){
            // g·ª≠i v·ªÅ app tr·∫°ng th√°i EXISTS
            location.href =
              "gi8://tgreg?status=EXISTS"
              + "&telegram_id=" + encodeURIComponent(String(tgUser.id || ""))
              + "&full_name=" + encodeURIComponent(((tgUser.first_name||"")+" "+(tgUser.last_name||"")).trim());
            return;
          }
          showMsg(data.message || "ƒêƒÉng k√Ω th·∫•t b·∫°i");
          return;
        }

        // ‚úÖ t·∫°o m·ªõi ho·∫∑c NEED_SET_PASSWORD -> g·ª≠i reg_token v·ªÅ app ƒë·ªÉ app local set password
        location.href =
          "gi8://tgreg?status=CREATED"
          + "&reg_token=" + encodeURIComponent(data.reg_token || "")
          + "&telegram_id=" + encodeURIComponent(String(data.telegram_id || ""))
          + "&full_name=" + encodeURIComponent(String(data.full_name || ""));
      }catch(e){
        showMsg("‚ùå L·ªói k·∫øt n·ªëi server");
      }
    };

    const s = document.createElement("script");
    s.async = true;
    s.src = "https://telegram.org/js/telegram-widget.js?22";
    s.setAttribute("data-telegram-login", TG_BOT_USERNAME);
    s.setAttribute("data-size", "large");
    s.setAttribute("data-userpic", "false");
    s.setAttribute("data-request-access", "write");
    s.setAttribute("data-onauth", "onTelegramAuth(user)");
    wrap.appendChild(s);
  }

  mountWidget();
</script>
</body>
</html>

