<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GI8 â€” ÄÄƒng nháº­p</title>
  <style>
    body{font-family:system-ui;background:#f5f7fb;margin:0;padding:16px}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);max-width:420px;margin:18px auto}
    .title{font-weight:900;font-size:18px;margin-bottom:10px}
    .msg{display:none;background:#fff3cd;border:1px solid #ffe69c;color:#6b4e00;padding:10px;border-radius:10px;font-weight:700;margin-bottom:10px}
    input{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px;margin:6px 0}
    button{width:100%;padding:10px;border:0;border-radius:10px;font-weight:900;margin-top:8px}
    .btn{background:#0d6efd;color:#fff}
    .btn2{background:#111;color:#fff}
    .sep{display:flex;align-items:center;gap:10px;margin:12px 0;color:#888;font-weight:800}
    .sep:before,.sep:after{content:"";flex:1;height:1px;background:#e6eaf2}
    .panel{margin-top:12px;padding:10px;border:1px dashed #cfd6e4;border-radius:12px;background:#fafcff;display:none}
  </style>
</head>
<body>
  <div class="card">
    <div class="title">ğŸ” Xá»• Sá»‘ Gi8 â€” ÄÄƒng nháº­p</div>

    <div id="msg" class="msg"></div>

    <div style="font-weight:900;margin-bottom:6px;">ÄÄƒng nháº­p báº±ng Username + Password</div>
    <input id="u" type="tel" inputmode="numeric" placeholder="Username (Telegram ID)" />
    <input id="p" type="password" placeholder="Password" />
    <button id="btnLogin" class="btn">Login</button>

    <div class="sep"><span>hoáº·c</span></div>

    <button id="btnShowTg" class="btn2">ğŸ§© Register by Telegram</button>

    <div id="tgPanel" class="panel">
      <div style="font-weight:900;margin-bottom:8px;">âœ… ÄÄƒng kÃ½ báº±ng Telegram</div>
      <div id="tgWrap"></div>

      <div id="pwPanel" style="display:none;margin-top:12px;">
        <div style="font-weight:900;margin-bottom:6px;">ğŸ”‘ Äáº·t máº­t kháº©u</div>
        <input id="pw" type="password" placeholder="Máº­t kháº©u (>= 4 kÃ½ tá»±)">
        <button id="btnSetPw" class="btn">LÆ°u máº­t kháº©u</button>
      </div>
    </div>
  </div>

<script>
  const TG_BOT_USERNAME = "gi8_check_bot"; // bot username (khÃ´ng cÃ³ @)
  const API_BASE = ""; // cÃ¹ng domain railway
  let reg_token = "";

  const $ = (id)=>document.getElementById(id);
  function showMsg(t){ const el=$("msg"); el.style.display="block"; el.textContent=t; }
  function hideMsg(){ const el=$("msg"); el.style.display="none"; el.textContent=""; }

  async function doLogin(){
    hideMsg();
    const telegram_id = ($("u").value||"").trim();
    const password = ($("p").value||"").trim();
    if(!telegram_id || !password) return showMsg("Thiáº¿u Username hoáº·c Password");

    const r = await fetch(API_BASE + "/auth/login",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ telegram_id, password })
    });
    const data = await r.json();

    if(!data.success){
      if(data.code==="NOT_FOUND") { showMsg("ChÆ°a cÃ³ tÃ i khoáº£n. Báº¥m Register by Telegram Ä‘á»ƒ Ä‘Äƒng kÃ½."); $("tgPanel").style.display="block"; return; }
      if(data.code==="WRONG_PASSWORD") return showMsg("Sai máº­t kháº©u");
      return showMsg(data.message || "Login tháº¥t báº¡i");
    }

    // âœ… Login OK -> redirect vá» callback -> deeplink vá» app
    location.href = "/auth/callback?token=" + encodeURIComponent(data.token);
  }

  function mountWidget(){
    const wrap = $("tgWrap");
    wrap.innerHTML = "";
    window.onTelegramAuth = async (tgUser)=>{
      hideMsg();
      const r = await fetch(API_BASE + "/auth/telegram-register",{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(tgUser)
      });
      const data = await r.json();

      if(!data.success){
        if(data.code==="EXISTS") return showMsg("TÃ i khoáº£n Ä‘Ã£ tá»“n táº¡i. HÃ£y login báº±ng Username + Password.");
        return showMsg(data.message || "ÄÄƒng kÃ½ tháº¥t báº¡i");
      }

      reg_token = data.reg_token || "";
      showMsg("âœ… ÄÄƒng kÃ½ Telegram OK. Vui lÃ²ng Ä‘áº·t máº­t kháº©u.");
      $("pwPanel").style.display = "block";
    };

    const s = document.createElement("script");
    s.async = true;
    s.src = "https://telegram.org/js/telegram-widget.js?22";
    s.setAttribute("data-telegram-login", TG_BOT_USERNAME);
    s.setAttribute("data-size", "large");
    s.setAttribute("data-userpic", "false");
    s.setAttribute("data-request-access", "write");
    s.setAttribute("data-onauth", "onTelegramAuth(user)");
    wrap.appendChild(s);
  }

  async function setPassword(){
    hideMsg();
    const password = ($("pw").value||"").trim();
    if(password.length < 4) return showMsg("Password tá»‘i thiá»ƒu 4 kÃ½ tá»±");
    if(!reg_token) return showMsg("Thiáº¿u reg_token. Vui lÃ²ng Ä‘Äƒng kÃ½ Telegram láº¡i.");

    const r = await fetch(API_BASE + "/auth/register-set-password",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ reg_token, password })
    });
    const data = await r.json();
    if(!data.success) return showMsg(data.message || "LÆ°u máº­t kháº©u tháº¥t báº¡i");

    // âœ… Set pass OK -> redirect vá» callback -> deeplink
    location.href = "/auth/callback?token=" + encodeURIComponent(data.token);
  }

  $("btnLogin").onclick = doLogin;
  $("btnShowTg").onclick = ()=>{ $("tgPanel").style.display="block"; mountWidget(); };
  $("btnSetPw").onclick = setPassword;
</script>
</body>
</html>
